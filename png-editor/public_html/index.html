<!doctype html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

    <head>
        <meta charset="utf-8">

        <title>PNG-Editor</title>
        <meta name="description" content="">

        <!-- Mobile viewport optimization h5bp.com/ad -->
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Home screen icon  Mathias Bynens mathiasbynens.be/notes/touch-icons -->
        <!-- For iPhone 4 with high-resolution Retina display: -->
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/h/apple-touch-icon.png">
        <!-- For first-generation iPad: -->
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/m/apple-touch-icon.png">
        <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
        <link rel="apple-touch-icon-precomposed" href="img/l/apple-touch-icon-precomposed.png">
        <!-- For nokia devices: -->
        <link rel="shortcut icon" href="img/l/apple-touch-icon.png">

        <!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
        <!-- <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
        <!-- <script>(function(){var a;if(navigator.platform==="iPad"){a=window.orientation!==90||window.orientation===-90?"img/startup-tablet-landscape.png":"img/startup-tablet-portrait.png"}else{a=window.devicePixelRatio===2?"img/startup-retina.png":"img/startup.png"}document.write('<link rel="apple-touch-startup-image" href="'+a+'"/>')})()</script> -->

        <!-- The script prevents links from opening in mobile safari. https://gist.github.com/1042026 -->
        <!-- <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script> -->

        <!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
        <meta http-equiv="cleartype" content="on">

        <!-- more tags for your 'head' to consider h5bp.com/d/head-Tips -->

        <style media="screen" type="text/css">
            #PNGEditorDiv input,
            #PNGEditorDiv textarea {
                font-family: monospace;
            }
            #filedrag
            {
                display: none;
                font-weight: bold;
                text-align: center;
                padding: 1em 0;
                margin: 1em 0;
                color: #555;
                border: 2px dashed #555;
                border-radius: 7px;
                cursor: default;
            }
            #filedrag.hover
            {
                color: #f00;
                border-color: #f00;
                border-style: solid;
                box-shadow: inset 0 3px 4px #888;
            }
            footer {
                background-color: #f5f5f5;
            }
        </style>

        <!-- Bootstrap -->
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">

        <!-- Main Stylesheet -->
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/main.css">

        <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
        <script src="js/libs/modernizr-2.0.6.min.js"></script>
    </head>

    <body>
        <div id="wrap">
            <header class="hero-unit">
                <h1>binPNG Editor</h1>
                <p>A binary PNG editor to learn basic image-processing algorithms and technics</p>
            </header>
            <div class="container-fluid">
                <div clas="row-fluid">
                    <nav class="span2">
                        <ul class="nav nav-list navbar-inner affix">
                            <li class="nav-header">Jump to</li>
                            <li><a href="#FileLoadStatusDiv">Status</a></li>
                            <li><a href="#EditedImageDiv">Edited png</a></li>
                            <li><a href="#OriginalImageDiv">Original png</a></li>
                            <li><a href="#PNGEditorDiv">PNG editor</a></li>
                        </ul>
                    </nav>

                    <div id="main" class="span10" role="main">
                        <!-- File load status -->
                        <div class="row">
                            <div id="FileLoadStatusDiv" class="span12"></div>
                        </div>

                        <div id="ImagesDiv" class="row-fluid">
                            <div id="EditedImageDiv" class="span6">
                                <h2>Edited image</h2>
                                <div>
                                    <form>
                                        <fieldset>
                                            <legend class="hidden"></legend>
                                            <label><i id="save-file-icon" class="icon-download" data-toogle="tooltip" title="Save edited image (not yet available)"></i></label>
                                        </fieldset>
                                    </form>
                                </div>
                                <img id="edited-image-img" alt="Edited Image" width="100" height="100" src="" class="img-polaroid" />
                            </div>

                            <div id="OriginalImageDiv" class="span6">
                                <h2>Original image</h2>
                                <div id="LoadFileDiv">
                                    <form name="file-form">
                                        <fieldset>
                                            <legend class="hidden">PNG file</legend>
                                            <label for="image-file"><i id="image-file-icon" class="icon-folder-open" data-toogle="tooltip" title="Select a file to load"></i></label>
                                            <span class="hidden"><input type="file" id="image-file" name="image-file" multiple=""/></span>
                                        </fieldset>
                                    </form>
                                </div>
                                <div id="file-drag">
                                    <img id="original-image-img" alt="Original Image" width="100" height="100" src="" class="img-polaroid" />
                                </div>
                            </div>
                        </div><!-- /#ImagesDiv -->

                        <div class="row-fluid">
                            <div id="PNGEditorDiv"></div>
                        </div>
                    </div><!-- /#main -->
                </div> <!-- /.row-fluid -->
            </div> <!-- /.container-fluid -->
        </div>

        <footer class="navbar navbar-fixed-bottom">
            <hr/>
            <p class="text-center"><small>&copy; 2013 ag</small></p>
            <p class="text-center"><small><a href="http://glyphicons.com">Glyphicons Free</a> licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</small></p>
        </footer>

        <!-- JavaScript at the bottom for fast page loading -->
        <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>');</script>

        <!-- Bootstrap -->
        <script src="bootstrap/js/bootstrap.min.js"></script>

        <!-- scripts concatenated and minified via ant build script-->
        <script src="js/helper.js"></script>
        <script src="js/png-editor/base64.js"></script>
        <script>
            $('#image-file-icon').tooltip();
            $('#save-file-icon').tooltip();

            /**
             * Byte Array to hexadecimal string
             * @param {ByteArray} bytes
             * @returns {String} white-spaces padded hexadecimal representation
             *          of the input array
             */
            function batohexs(bytes) {
                var result = '';
                if (bytes) {
                    var hexDigits = '0123456789ABCDEF';
                    var length = bytes.length;
                    for (var i = 0; i < length; ++i) {
                        result += hexDigits[bytes[i] >> 4] + hexDigits[bytes[i] & 0x0f] + ' ';
                    }
                }
                return result;
            }

            /**
             * String with hexadecimal number to ByteArray
             * @param {String} hexs String containing number in white-spaces
             *       padded hexadecimal notation
             * @returns {ByteArray} bytes
             */
            function hexstoba(hexs) {
                var bytes = [];
                if (hexs) {
                    var i = 0; // index in the string
                    var j = 0; // index in the array
                    while (i < hexs.length) {
                        bytes[j++] = parseInt(hexs.substring(i, i + 2), 16);
                        i += 3;
                    }
                }
                return new Uint8Array(bytes);
            }

// Not needed if using DataView ??
//            /**
//             *  ByteArray to 32 bit integer
//             *  @param {ByteArray} bytes 4 bytes in network order
//             *  @return {Number} 32 bit integer
//             */
//            function batoi(bytes) {
//                var val = 0;
//                for (var i = 0; i < 4; ++i) {
//                    val *= 256;
//                    val += bytes[i];
//                }
//                return val;
//            }

            /**
             *  ByteArray to String interpreting each byte as char codes
             *  @param {ByteArray} bytes in network order
             *  @return {String}
             */
            function batos(bytes) {
                var result = '';
                for (var i = 0; i < bytes.length; ++i) {
                    result += String.fromCharCode(bytes[i]);
                }
                return result;
            }

            /**
             * Byte array to base64-encoded string
             * @see <a href="http://stackoverflow.com/a/5370394/413020">Convert
             *      array of byte values to base64 encoded string and break long
             *      lines, Javascript (code golf)</a>
             * @param {ByteArray} input
             * @returns {String} base64-encoded input buffer
             */
            function batobase64(input) {
                var str = "";
                for (var i = 0; i < input.length; i++) {
                    str += String.fromCharCode(input[i]);
                }
                return btoa(str).replace(/.{76}(?=.)/g, '$&\n');
            }

            /**
             * @see <a href="http://stackoverflow.com/a/2117523/413020">How to
             *      create a GUID / UUID in Javascript?</a>
             * @returns {String} rfc4122 ver 4 compliant guid
             */
            function guid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            /**
             * @class 
             * @param {ArrayBuffer} buffer raw image data
             * @param {Number} start pointer to the start of the chunk in the
             *       ArrayBuffer
             */
            function Chunk(buffer, start) {
                var _chunkStartPtr = start; // Points to the start of the chunk
                var _bytes = new Uint8Array(buffer);
                var _dataView = new DataView(buffer);
                var _listeners = [];
                var _notifyListeners = function() {
                    for (var i = 0; i < _listeners.length; i++) {
                        _listeners[i]();
                    }
                };
                /**
                 * @returns {Number} length of data block
                 */
                var _getDataLength = function() {
                    return _dataView.getUint32(_chunkStartPtr);
                };
                return {
                    /**
                     * @param {function} l listener that will be notified on
                     *       changes
                     */
                    addListener: function(l) {
                        _listeners.push(l);
                    },
                    /**
                     * @returns {String}
                     */
                    getLengthHex: function() {
                        return batohexs(_bytes.subarray(_chunkStartPtr, _chunkStartPtr + 4));
                    },
                    /**
                     * Overwrites the corresponding bytes of the original image.
                     * Changing the bytes notifies all listeners
                     * @param {String} hex string containing number in
                     *       hexadecimal notation
                     * @returns {Chunk} this for method chaining
                     */
                    setLengthHex: function(hex) {
                        var hexBytes = hexstoba(hex);
                        var _ptr = _chunkStartPtr;
                        for (var i = 0; i < hexBytes.length; ++i, ++_ptr) {
                            _bytes[_ptr] = hexBytes[i];
                        }
                        _notifyListeners();
                        return this;
                    },
                    /**
                     * @returns {String}
                     */
                    getLengthDec: function() {
                        return _dataView.getInt32(_chunkStartPtr);
                    },
                    /**
                     * Overwrites the corresponding bytes of the original image.
                     * Changing the bytes notifies all listeners
                     * @param {Number} length length of the chunk in bytes
                     * @returns {Chunk} this for method chaining
                     */
                    setLengthDec: function(length) {
                        _dataView.setUint32(_chunkStartPtr, length);
                        _notifyListeners();
                        return this;
                    },
                    /**
                     * @returns {Number} chunk's length in bytes
                     */
                    getChunksLength: function() {
                        return _getDataLength() + 4 + 4 + 4; // length + name + crc
                    },
                    /**
                     * @returns {String}
                     */
                    getNameHex: function() {
                        return batohexs(_bytes.subarray(_chunkStartPtr + 4, _chunkStartPtr + 8));
                    },
                    /**
                     * @returns {String}
                     */
                    getName: function() {
                        return batos(_bytes.subarray(_chunkStartPtr + 4, _chunkStartPtr + 8));
                    },
                    /**
                     * @returns {String}
                     */
                    getDataHex: function() {
                        return batohexs(_bytes.subarray(_chunkStartPtr + 8, _chunkStartPtr + 8 + _getDataLength()));
                    },
                    /**
                     * @returns {String}
                     */
                    getCrcHex: function() {
                        return batohexs(_bytes.subarray(_chunkStartPtr + 8 + _getDataLength(), _chunkStartPtr + 8 + _getDataLength() + 4));
                    },
                    /**
                     * @returns {Number}
                     */
                    getCrc: function() {
                        return _dataView.getInt32(_chunkStartPtr + 8 + _getDataLength());
                    }
                };
            }

            /**
             * @class  API to access png data
             * @param {ArrayBuffer} buffer raw png data
             */
            function PngImage(buffer) {
                var _bytes = new Uint8Array(buffer);
                var _dataView = new DataView(buffer);
                var WIDTH_PTR = 8 + 4 + 4; // Signature + IHDR's length + Chunks' name
                var HEIGHT_PTR = WIDTH_PTR + 4;
                var _signature = _bytes.subarray(0, 8);
                var _width = _dataView.getUint32(WIDTH_PTR);
                var _height = _dataView.getUint32(HEIGHT_PTR);
                var _chunks = {};
                var _listeners = [];
                // pointer to the index in the byte array of the next chunk to read
                var _ptr = 8;
                var _nChunks = 0;
                var _that = {
                    /**
                     * 
                     * @param {function} l will be called on image changes
                     * @returns {PngImage} this for method chaining
                     */
                    addListener: function(l) {
                        _listeners.push(l);
                        return this;
                    },
                    /**
                     * 
                     * @returns {PngImage} this for method chaining
                     */
                    notifyListeners: function() {
                        for (var i = 0; i < _listeners.length; ++i) {
                            _listeners[i]();
                        }
                        return this;
                    },
                    /**
                     * @param {Element} tag where to render the image
                     */
                    renderInImg: function(tag) {
                        var encodedBytes = batobase64(_bytes);
                        tag.setAttribute('src', 'data:image/png;base64,' + encodedBytes);
                        tag.setAttribute('width', '' + this.getWidth());
                        tag.setAttribute('height', '' + this.getHeight());
                    },
                    /**
                     * @returns {String}
                     */
                    getSignatureHex: function() {
                        return batohexs(_signature);
                    },
                    /**
                     * @returns {Number}
                     */
                    getWidth: function() {
                        return _width;
                    },
                    /**
                     * @returns {Number}
                     */
                    getHeight: function() {
                        return _height;
                    },
                    /**
                     * @returns {Array} map of chunks
                     */
                    getChunks: function() {
                        return _chunks;
                    }
                };
                // read chunks
                console.log('Reading chunks...');
                while (_ptr < _bytes.length) {
                    var c = Chunk(buffer, _ptr);
                    c.addListener(_that.notifyListeners);
                    console.log('Read chunk named "' + c.getName() + '" of length ' + c.getChunksLength() + ' bytes.');
                    _chunks[c.getName()] = c;
                    _ptr += c.getChunksLength();
                    ++_nChunks;
                }
                console.log(_nChunks + ' chunks read');
                return _that;
            }

            /**
             * @class Provides the API to create the PNG GUI
             * @param {Element} gUIDiv where to append the html
             * @param {PngImage} pngImage
             * @returns {PngEditor} this for method chaining
             */
            function PngGUI(gUIDiv, pngImage) {
                var _pngImage = pngImage;
                var _viewportJQuery;

                /**
                 * @returns {Element}
                 */
                var _createSignatureGUI = function() {
                    var div = $('<div>'
                            + '<header>File signature</header>'
                            + '<label>Signature</label>'
                            + '</div>');
                    div.append(
                            $('<input name="signature-textarea" type="text" size="24" readonly="readonly"/>')
                            .attr('value', _pngImage.getSignatureHex()));
                    return div;
                };

                /**
                 * 
                 * @param {Chunk} chunk
                 * @param {Number} index which chunk it is
                 * @returns {jQuery} GUI element
                 */
                var _createChunkGUI = function(chunk, index) {
                    var div = $('<div><header>Chunk ' + index + ': ' + chunk.getName() + '</header>');

                    var LENGTH_WIDTH = Math.ceil(Math.log(Math.pow(2, 32) - 1) / Math.log(10)); // Max length
                    // Length
                    var lengthHexInput = $('<input name="chunk-0-length-textarea" type="text" size="12" value="' + chunk.getLengthHex() + '"/>');
                    lengthHexInput.on("change", function() {
                        chunk.setLengthHex(this.value);
                    });
                    chunk.addListener(function() {
                        lengthHexInput.val(chunk.getLengthHex());
                    });
                    console.log("Chunks length: " + chunk.getLengthDec());
                    var lengthDecInput = $('<input name="chunk-0-length-ascii-textarea" type="text" size="' + LENGTH_WIDTH + '" value="' + chunk.getLengthDec() + '"/><sub>bytes</sub>');
                    lengthDecInput.on("change", function() {
                        chunk.setLengthDec(this.value);
                    });
                    chunk.addListener(function() {
                        lengthDecInput.val(chunk.getLengthDec());
                    });
                    div.append($('<label>Length</label>'))
                            .append(lengthHexInput)
                            .append(lengthDecInput);

                    // Type/Name
                    div.append($('<label>Type/Name</label>'))
                            .append($('<input name="chunk-0-type-textarea" type="text" size="12" value="' + chunk.getNameHex() + '"/>'))
                            .append($('<input name="chunk-0-type-ascii-textarea" type="text" size="4" value="' + chunk.getName() + '"/><sub>ASCII</sub></label>'));

                    // Data
                    div.append($('<label>Data</label>'))
                            .append($('<textarea name="chunk-0-data-textarea" rows="4" cols="50">' + chunk.getDataHex() + '</textarea>'));

                    // CRC
                    div.append($('<label>CRC</label>'))
                            .append($('<input name="chunk-0-crc-textarea" type="text" size="12" value="' + chunk.getCrcHex() + '"/>'))
                            .append($('<input name="chunk-0-crc-ascii-textarea" type="text" size="10"  value="' + chunk.getCrc() + '"/><sub>dec</sub>'));

                    return div;
                };

                var _createChunksGUI = function() {
                    var div = $('<div><div/>');
                    var names = Object.keys(_pngImage.getChunks());
                    console.log('chunks:' + names.length);
                    for (var i = 0; i < names.length; ++i) {
                        div.append(_createChunkGUI(_pngImage.getChunks()[names[i]], i));
                    }
                    return div;
                };

                var _redraw = function() {
                    _pngImage.renderInImg(_viewportJQuery[0]);
                };
                _pngImage.addListener(_redraw);
                var _element = $('<div><div/>')
                        .append(_createSignatureGUI())
                        .append(_createChunksGUI());

                return {
                    /**
                     * @param {Element} viewportTag
                     * @return {PngEditor} this for method chaining
                     */
                    setImageViewport: function(viewportTag) {
                        _viewportJQuery = $(viewportTag);
                        _redraw();
                        return this;
                    },
                    refresh: function() {
                        $(gUIDiv).empty().append(_element);
                    }
                };
            }

            function initDragAndDrop() {
                var filedrag = $("#file-drag")[0];
                var fileselect = $("#image-file")[0];
                // file select
                fileselect.addEventListener("change", fileSelectHandler, false);
                // is XHR2 available?
                var xhr = new XMLHttpRequest();
                if (xhr.upload) {
                    // file drop
                    filedrag.addEventListener("dragover", fileDragHover, false);
                    filedrag.addEventListener("dragleave", fileDragHover, false);
                    filedrag.addEventListener("drop", fileSelectHandler, false);
                    filedrag.style.display = "block";
                }
            }

            function fileDragHover(e) {
                e.stopPropagation();
                e.preventDefault();
                e.target.className = (e.type === "dragover" ? "hover" : "");
            }

            /**
             * File selection
             * @param {Event} e
             */
            function fileSelectHandler(e) {
                // cancel event and hover styling
                fileDragHover(e);
                // fetch FileList object
                var files = e.target.files || e.dataTransfer.files;
                parseFile(files[0]);
            }

            /**
             * Output file information
             * @param {File} file
             */
            function parseFile(file) {
                $("#FileLoadStatusDiv").append($(
                        "<p>File information: <strong>" + file.name +
                        "</strong> type: <strong>" + file.type +
                        "</strong> size: <strong>" + file.size +
                        "</strong> bytes</p>"
                        ));
                if (file.type === "image/png") {
                    parseImage(file);
                }
            }

            /**
             * Parses the image file
             * @param {File} file
             */
            function parseImage(file) {
                if (!window.FileReader)
                    return; // Browser is not compatible

                var reader = new FileReader();

                reader.onload = function(evt) {
                    if (evt.target.readyState !== 2)
                        return;
                    if (evt.target.error) {
                        alert('Error while reading file');
                        return;
                    }

                    var pngImage = PngImage(evt.target.result);

                    // Render original image
                    pngImage.renderInImg($('#original-image-img')[0]);

                    // Re-create GUI editor and refresh image
                    PngGUI($('#PNGEditorDiv')[0], pngImage)
                            .setImageViewport($('#edited-image-img')[0])
                            .refresh();
                };

                reader.readAsArrayBuffer(file);

            }

            if (window.File && window.FileList && window.FileReader) {
                initDragAndDrop();
            }
        </script>
        <!-- end scripts-->

        <!-- Debugger - remove for production -->
        <!-- <script src="https://getfirebug.com/firebug-lite.js"></script> -->
    </body>
</html>
